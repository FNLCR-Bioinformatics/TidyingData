---
title: "BTEP-DateTime"
author: "Drs. Sarangan Ravichandran and Randall Johnson"
date: "May 16, 2017" 
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(knitr)
```
Let us load the libraries
```{r loadlibraries}
library(tidyverse) 
```


### Date & Times in R

Dates and Times are very important. 
Routinely used in expression (gene) data


```{r}
D1 <- as.Date('1920-6-16')
class(D1)

D2 <- as.Date('2017/03/07')
class(D2)

## Current Date from System 
Sys.Date()

```

If you use <code> ?as.date </code>, you will see the formats that 
the function takes. 
```{r kable, echo = FALSE}
Code <- c("%d", "%m","%b","%B","%y","%Y")
Value <- c("Day of the month (decimal numeber)", "Month(decimal number)", "Month (abbreviation)",
           "Month(full name)", "Year (2 digit)", "Year (4 digit)")
tibble1 <- tibble(Code, Value)
kable(tibble1)
```

The function <pre> <code> as.Date </code> </pre> expects the date to be in the - separated format. 
If it is not, then we should use the following format

```{r}
as.Date('03/07/2017', format='%m/%d/%Y')
as.Date('March 07, 2017', format='%B %d, %Y')
```

Let us look to see how R stores the data internally.
Two different datatypes that deal with Time and Date variables: 

### POSIXct

Will provide you the number of seconds that has been elapsed since January 1, 1970. 

Negative numebrs indicate seconds before this time. 

### POSIXlt

- Type of vector

```{r kable1, echo = FALSE}
Position <- 1:9
Value <- c("seconds","minutes","hours","day of the month (1-31)", "month of the year (0-11)", 
           "years since 1900", "day of the week (0: Sunday - 6: Saturday)", "Day of the year (0-365)",
           "Daylight savings indicator (Positive/Negative: Yes/No")
library(knitr)
tibble2 <- tibble(Position, Value)
kable(tibble2)

```

Let us see how we can use these two data types:

```{r}
(timext <- Sys.time())
class(timext)
typeof(timext)
cat(timext, "\n")

(timelt <- as.POSIXlt(timext) )
typeof(timelt)
names(timelt)
lapply(timelt, function(x) print(x))
```

### How can we use the time? 
 
```{r}
timenow <- Sys.time()
timenow
timenow - 30 # 30 seconds earlier 

```
Be careful with time data that are used for numerical calculations. 


### How to store Time in different formats and use it at a later time or using a differnt software?

Two commands that can help us accomplish this, strftime and strptime.

strftime: converts a time data and convert it to a string
strptime: converts a sting and convert it to Date/time format suitable for R calculations
```{r}
# note the default format for this is "%Y-%m-%d %H:%M:%S"
string_timenow <- strftime(timenow)  #"2017-03-07 15:52:03 EST"
string_timenow
class(string_timenow)
class(timenow)
typeof(string_timenow)
(Posixct_timenow <- strptime(string_timenow,"%Y-%m-%d %H:%M:%S" ))
class(Posixct_timenow)
```


### <span style="color:green">Final R exercise that use Time variable</span>

The datset that we will be using for this section comes from the  
National Electronic Injury Surveillance System (NEISS)
https://www.cpsc.gov/research--statistics/neiss-injury-data 
Here is a short description of the data file from the NEISS. 

*"Each record (case) is separated by a carriage return/line feed, and the
fields (parameters and narrative) are separated by a tab character, which you can specify as the delimiter when importing into a spreadsheet or database."*

Before you read in the data, please source the following file: **Data/NEISSlabels.R**
This file will provide human readable labels for the codes in the nss15 dataset. You may also find the `get_label()` function in this file useful. For example, if you want to get body part codes for `c(0, 33, 37, 33)`, you could do it like so:

```{r get label}
source('Data/NEISSlabels.R')
# the hard/ugly way
sapply(c(0, 33, 37, 33), function(x) which(body_part == x)) %>%
	names()

# the easy way
get_label(c(0, 33, 37, 33), body_part)
```

Read the data file, **nss15.tsv** file from the sub-folder/directory, **Data** and call the data as **nss15** variable.

**Hint:** Use the File --> Import --> Data DataSet option to read the file. 
To remind the data is in a tab-separated format.

**Hint:** Watch out for the Data Type choices that are suggested to you and choose the appropriate ones

**Hint:** Please watch out for any warnings or issues while R/Rstudio 
is reading the files. If you spot any errors, think of how to fix it.
After fixing the problems (if any), go back and read the file. 
 
Answer the following questions.

- Report the number of cases for the month of May? 
  Tell us how many cases were reported for May 13 - May 16, 2015? 
  Use this information to answer the following questions. 
- What hospitals were the cases went to (provide a table)?
- How many were children ( < 5 years)? 
- provide the proportion of male/female? 
- What was the race distribution? 


### What is a Regex?

- Was originally developed for PERL
- Regular Expressions help us identify patterns in text. 
- Cross-platform compatible
- Speed up calculations

### How do they work?



###  Example 1

```{r}
x <- c("BCR_613", "")
```

### Example for using Grep

```{r}

IDS <-	c("NP_004`318.3", "XP_003317181.1", "XP_002798337.1", "XP_848654.2", "NP_001074881.1", "XP_228091.6", "XP_415244.3", "NP_001123792.1", "XP_005161278")

grepids <- grep(pattern = "NP", x = IDS)

IDS[grepids]

MIDS <-	c("NP_004`318.3", "XP_003317181.1", "XP_002798337.1", "XP_848654.2", "np_001074881.1", "XP_228091.6", "XP_415244.3", "NP_001123792.1", "XP_005161278")


grepmids <- grep("NP", MIDS, ignore.case = FALSE)
IDS[grepmids]

grepmids <- grep("NP", MIDS, ignore.case = TRUE)
IDS[grepmids]

```

### What is grepl?

```{r}
grepl("NP", MIDS, ignore.case = TRUE) 
```



### What are sub and gsub functions? 

```{r}
species <- c("Arabidopsis_thaliana", "Bos_taurus", "Caenorhabditis_elegans", "Danio_rerio", 
             "Dictyostelium_discoideum", "Drosophila_melanogaster", "Escherichia_coli",
             "Homo_sapiens", "Mus_musculus", "Mycoplasma_pneumoniae",
             "Oryza_sativa","Plasmodium_falciparum","Pneumocystis_carinii","Rattus_norvegicus",
             "Saccharmomyces_cerevisiae","Schizosaccharomyces_pombe","Takifugu_rubripes","Xenopus_laevis",
             "Zea_mays")
species
```

```{r}

sub("_", " ", species)
```
## Let us look at what happens when we add a new species.
```{r}
mspecies <- c(species, "Hepatitis_C_Virus")
mspecies
grep(pattern="g.cus", mspecies)
```
Let us use the substitute, sub, command on the modified string?

```{r}
sub("_", " ", mspecies)
```

What happened? 

sub will only modify the first occurance of the pattern. To modify all occurances in a string,
use gsub

```{r}
gsub("_", " ", mspecies)
```


### Can we look for a word in each strings? 

-regexpr returns the position in the string of the pattern. It will also return the length of 
the pattern matched.

```{r}
regexpr("sa", mspecies)
```

### <span style="color:green">RegEx Exercise-1</span> 

- Find out what regexec and  gregexpr


## You can combine regex keywords 

```{r}
grep("sapiens|sativa", mspecies)
```

```{r}
mylist <- c("b*taurus", "C*elegans", "D*rerio", 
             "H*sapiens", "M*musculus", "R*norvegicus")

grep("H*sapiens", mspecies, ignore.case = TRUE)
```

Note that <code>\\</code> is used for escapting a character


