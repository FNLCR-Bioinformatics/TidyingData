---
title: "BTEP-Tibl-Tidying"
author: "Drs. Sarangan Ravichandran and Randall Johnson"
date: "May 16, 2017"
output: github_document
---
### Cleaning up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Before we begin, let us clean up the environment and set a working directory. 
This will clear all the variables and start fresh. 
If you want to follow on, then we suggest you set your working directory to the root directory of your local copy of the TidyingData repository.

You can get and set a working directory by the following commands: 
```{r, eval = FALSE}
getwd()
setwd("<TidyingData_Directory>")
# for example:
# setwd("H:/2017/BTEP1-TidyingData")
```

You may also want to clear your workspace.
```{r CleanSetRoot, eval = FALSE}
rm(list = ls())
```

### Loading the libraries

Let us first load the libraries needed for the workshop
```{r loadlibraries, results = "hide" }
# if you dont have tidyverse then run the following line once 
# install.packages(c("tidyverse", "knitr"))
library(tidyverse)
library(knitr)
library(lubridate)
```


In the tidyverse the commonly returning objects are not data.frame but tibbles.
So, let us introduce tibble in this section. 

## Tibble

What is tibble?

- modern way of loooking at the traditional data.frame 
- you will get a lot more useful information than the data.frames
- tibble is part of tibble package and part of the core tidyverse package
 
To get help, use 
```{r, tibblehelp, eval=FALSE}
?tibble
vignette("tibble")

```

 
How to create a tibble? 
```{r create-tibble}
tibble(
  x = 1:5, 
  y = LETTERS[1:5], 
  z = x^2 + 20
)

```
What is the difference between the R regular data.frame and 
tibble (data_frame)?

```{r TibblevsDataframe}
employee <- c('John Wayne','Peter Doe','Esther Julie')
salary <- c(20000, 23400, 26800)
startdate <- as.Date(c('2016-12-1','2007-3-25','2016-3-14'))
df <- data.frame(employee, salary, startdate)
df

as_tibble(df)

```

Let us create a data.frame and a tibble. 

```{r}
df1 <- data.frame( Color = "Red")
tb1 <-tibble(Color = "Red")
```

### <span style="color:green">Tibble Exercise-1</span>

If you type the following commmands, what will you get and 
explain your reasoning:

```{r, eval = F}
df1$C
tb1$C

class(df1$Color)
class(tb1$Color)
```

Also, speculate on the type of object that you will get from 
each of these above two operations? 

The above explains traditional R data.frame is helpful in 
filling in the missing information. Also how data.frame modifies
the variable type without asking (ex Character to Factor)

### Map function example

```{r eval = FALSE}
purr::map_dbl(mtcars, mean)
purrr:map_dbl(mtcars, mean)

tb1 <- as.tibble( Color = "red")
tb1$C  
```

you can coerce regular R data frame into tibble. Let us look at the R dataset, cars.
Let us learn about cars datset 

<pre> <code>
  ?cars
</code></pre>

Let us find out what class cars object belongs to and how to convert cars data frame into
tibbles object. Note that 

```{r coerce-tibble}
class(cars)
as_tibble(cars)
head(cars) #otherwise you get all 50 rows
```

## Why Tibble? 

- Tibble doesnt change the inputs. Ex. strings to factors 
- Doesnt add new names or modify the inputs
- For example, Tibble never converts strings to factors

## What is tribble

- transposed tibble, tribble()
- small data in readable form
- column headings are shown as formulas ( ie ~ )
- nice format
- no need to explicitely use head command (Ex. head cars)


```{r}
tribble(
  ~x, ~y, ~z,
  #--|--|----
  "Male", 187, 210,
  "Female", 190, 150
)
```

Let us create a little bit complicated tibble 
note that lubridate gives the current time

```{r complicatedtibble, results= 'asis'}
t2 <- tibble(
  a = lubridate::now() + runif(1e3) * 86400,
  b = lubridate::today() + runif(1e3) * 30,
  c = 1:1e3,
  d = runif(1e3),
  e = sample(letters, 1e3, replace = TRUE)
)
```


```{r}
t2
```

You can change the defaults of tibble display with options.

```{r}
options(tibble.print_max = 10, tibble.print_min = 6)
t2
```

You can also use the following tibble option to show all columns
```{r, eval=FALSE}
options(tibble.width = Inf)
# more options available at 
package?tibble
```


How to extract the columns or rows of tibble?

```{r}
head(t2$a)

has_name(t2, "b")
getOption("tibble.max_extra_cols")
```

how to add a row of a tibble in a specific place?

original t2 
```{r}
t2
```

```{r ,results='as.is'}
    aa = lubridate::today()
    bb = lubridate::now()
    cc = 1:1
    dd = runif(1)
    ee = sample(letters, 1, replace = TRUE)
    print(aa); print(bb); print(cc); print(dd); print(ee)
t2 %>% 
  add_row(
    a = aa, 
    b = bb,
    c = cc,
    d = dd,
    e = ee, .before = 2  # note the dot in ".before = 2"
)

```
After the change

```{r}
t2
```

## Subsetting 

- \$ by name
- `[[` works for column numbers, names, or variables containing names

```{r}

df <- tibble(
  x = runif(5),
  y = rnorm(5)
)

df$x

df[[1]]

df[['x']]

pick_me <- 'x'
df[[pick_me]]
```

Can you use Tibble in a pipeline?

```{r}
df %>% .$x   

df %>% .[["y"]]
```

What happens if tibble doesnt work with a package? This is rare -- we only know of one package where tibbles don't quite work, and even then they mostly work as expected. 
Transform Tibble back to a data.frame using the following command:
```{r}
as.data.frame(df)
```


### <span style="color:green">Tibble Exercise-2</span>

Create a new tibble with the following information:
  name, age, height, weight, smoker (T or F), Male (True or False)
 compare the tibble with the R data_frame


### <span style="color:green">Tibble Exercise-3</span>

convert iris data set (given to us in data.frame ) to tibble data_frame


### <span style="color:green">Tibble Exercise-4</span>

How can you tell whether the object is a Tibble or not? 

### <span style="color:green">Tibble Exercise-5 (based on Hadley's tutorial) </span>

Partial matching is a big issue with data.frame.
df <- data.frame(abc = 1, xyz = "a")
df$x
df[, "xyz"]


### <span style="color:green">Final R-basic exercise</span>

The datset that we will be using for this section comes from the  
National Electronic Injury Surveillance System (NEISS)
https://www.cpsc.gov/research--statistics/neiss-injury-data 
Here is a short description of the data file from the NEISS. 

*"Each record (case) is separated by a carriage return/line feed, and the
fields (parameters and narrative) are separated by a tab character, which you can specify as the delimiter when importing into a spreadsheet or database."*

Before you read in the data, please source the following file: **Data/NEISSlabels.R**
This file will provide human readable labels for the codes in the nss15 dataset. 

Read the data file, **nss15.tsv** file from the sub-folder/directory, **Data** and call the data as **nss15** variable.

**Hint:** Use the File --> Import --> Data DataSet option to read the file. 
To remind the data is in a tab-separated format.

**Hint:** Watch out for the Data Type choices that are suggested to you and choose the appropriate ones

**Hint:** Please watch out for any warnings or issues while R/Rstudio 
is reading the files. If you spot any errors, think of how to fix it.
After fixing the problems (if any), go back and read the file. 
 
Answer the following questions.

- How many cases are reported in this dataset?
- How many covariates this dataset has? 
- Access CPSC Case # 150620565 and report the following things:
  What is the age of the patient? 
  What is the Race, weight, Stratum, Sex, Race and Diagnosis
- How many are more than 100 years old?  
- How many cases were taken to **Children's Hospital**?
  From the reported cases, get the CPSC case number and age for the 20th entry.
 
### Ignore from here to the end for the moment


## Hands-on exercise using Wisconsin Breast Cancer dataset

Now, let us read a slightly complicated Breast Cancer dataset. First let us use
the import data set drop-down option 

![](Images/RS-ImportDataset.png)
![](Images/RS-ImportDataset1.png)
```{r readdata}
#wdbc <- read_csv("C:/Users/Ravi/Desktop/BTEP/Data/wdbc.data", col_names = FALSE)

wdbc <- read_csv("Data/wdbc.data", col_names = FALSE)
#wdbctry2 <- read_csv("C:/Users/Ravi/Desktop/BTEP/Data/wdbc.data", header = FALSE)
names(wdbc)
```

Let us add column names

```{r AssignColnams}
cnames <- c("ID", "Diagnosis", 
            "radius", "Texture", "Perimeter", "area",
            "smoothness", "compactness", "concavity", "concave_points",
            "symmetry","fractaldim",
            "radiusSE", "TextureSE", "PerimeterSE", "areaSE",
            "smoothnessSE", "compactnessSE", "concavitySE", "concave_pointsSE",
            "symmetrySE","fractaldimSE",
            "radiusW", "TextureW", "PerimeterW", "areaW",
            "smoothnessW", "compactnessW", "concavityW", "concave_pointsW",
            "symmetryW","fractaldimW")

names(wdbc) <- cnames
```
 Let us find out how many samples we have in the dataset? 
 
 
```{r}
nrow(wdbc)
```
How many covariates are in the dataset? 
We can look at the Global environment (top right) window to get the information
We can also find that out by typing the following command:
```{r}
ncol(wdbc)
```



## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.


```{r cars, fig.cap = "cars"}
with(cars, plot(speed,dist))
```